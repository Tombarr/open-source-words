paperclip deprecated paperclip is deprecated for new projects we recommend rails own activestorage for existing projects please consult and contribute to the migration guide en español we will leave the issues open as a discussion forum only we do not guarantee a response from us in the issues we are no longer accepting pull requests except pull requests against the migration guide all other pull requests will be closed without merging existing documentation documentation valid for master branch please check the documentation for the paperclip version you are using https github com thoughtbot paperclip releases start doctoc generated toc please keep comment here to allow auto update dont edit this section instead re run doctoc to update requirements ruby and rails image processor file installation quick start models migrations edit and new views edit and new views with simple form controller view helpers checking a file exists deleting an attachment usage validations internationalization i18n security validations defaults migrations add attachment column to a table schema definition vintage syntax storage understanding storage io adapters post processing custom attachment processors events uri obfuscation checksum fingerprint file preservation for soft delete dynamic configuration dynamic styles dynamic processors logging deployment attachment styles testing contributing license about thoughtbot end doctoc generated toc please keep comment here to allow auto update paperclip is intended as an easy file attachment library for activerecord the intent behind it was to keep setup as easy as possible and to treat files as much like other attributes as possible this means they arent saved to their final locations on disk nor are they deleted if set to nil until activerecord base save is called it manages validations based on size and presence if required it can transform its assigned image into thumbnails if needed and the prerequisites are as simple as installing imagemagick which for most modern unix based systems is as easy as installing the right packages attached files are saved to the filesystem and referenced in the browser by an easily understandable specification which has sensible and useful defaults see the documentation for has attached file in paperclip classmethods for more detailed options the complete rdoc is online requirements ruby and rails paperclip now requires ruby version 2 1 and rails version 4 2 only if youre going to use paperclip with ruby on rails image processor imagemagick must be installed and paperclip must have access to it to ensure that it does on your command line run which convert one of the imagemagick utilities this will give you the path where that utility is installed for example it might return usr local bin convert then in your environment config file let paperclip know to look there by adding that directory to its path in development mode you might add this line to config environments development rb ruby paperclip options command path usr local bin if youre on mac os x youll want to run the following with homebrew brew install imagemagick if you are dealing with pdf uploads or running the test suite youll also need to install ghostscript on mac os x you can also install that using homebrew brew install gs if you are on ubuntu or any debian base linux distribution youll want to run the following with apt get sudo apt get install imagemagick y file the unix file command is required for content type checking this utility isnt available in windows but comes bundled with ruby devkit so windows users must make sure that the devkit is installed and added to the system path manual installation if youre using windows 7 as a development environment you may need to install the file exe application manually the file spoofing system in paperclip 4 relies on this if you dont have it working youll receive validation failed upload file has an extension that does not match its contents errors to manually install you should perform the following download install file from this url to test you can use the image below next you need to integrate with your environment preferably through the path variable or by changing your config environments development rb file path 1 click start 2 on computer right click and select properties 3 in properties select advanced system settings 4 click the environment variables button 5 locate the path var at the end add the path to your newly installed file exe typically c \program files x86 \gnuwin32\bin 6 restart any cmd shells you have open see if it works or environment 1 open config environments development rb 2 add the following line paperclip options command path c \program files x86 \gnuwin32\bin 3 restart your rails server either of these methods will give your rails setup access to the file exe functionality thus providing the ability to check the contents of a file fixing the spoofing problem installation paperclip is distributed as a gem which is how it should be used in your app include the gem in your gemfile ruby gem paperclip 6 0 0 or if you want to get the latest you can get master from the main paperclip repository ruby gem paperclip git git github com thoughtbot paperclip git if youre trying to use features that dont seem to be in the latest released gem but are mentioned in this readme then you probably need to specify the master branch if you want to use them this readme is probably ahead of the latest released version if youre reading it on github for non rails usage ruby class modulename activerecord base include paperclip glue end quick start models ruby class user activerecord base has attached file avatar styles medium 300x300 thumb 100x100 default url images style missing png validates attachment content type avatar content type \aimage\ \z end migrations assuming you have a users table add an avatar column to the users table ruby class addavatarcolumnstousers activerecord migration def up add attachment users avatar end def down remove attachment users avatar end end or you can use the rails migration generator rails generate paperclip user avatar edit and new views make sure you have corresponding methods in your controller erb form for user url users path html multipart true do form form file field avatar form submit end edit and new views with simple form erb simple form for user url users path do form form input avatar as file form submit end controller ruby def create user user create user params end private use strong parameters for attribute whitelisting be sure to update your create and update controller methods def user params params require user permit avatar end view helpers add these to the view where you want your images displayed erb image tag user avatar url image tag user avatar url medium image tag user avatar url thumb checking a file exists there are two methods for checking if a file exists file and present checks if the file name field is populated exists checks if the file exists will perform a tcp connection if stored in the cloud keep this in mind if you are checking if files are present in a loop the first version is significantly more performant but has different semantics deleting an attachment set the attribute to nil and save ruby user avatar nil user save usage the basics of paperclip are quite simple declare that your model has an attachment with the has attached file method and give it a name paperclip will wrap up to four attributes all prefixed with that attachments name so you can have multiple attachments per model if you wish and give them a friendly front end these attributes are attachment file name attachment file size attachment content type attachment updated at by default only attachment file name is required for paperclip to operate youll need to add attachment content type in case you want to use content type validation more information about the options passed to has attached file is available in the documentation of paperclip classmethods validations for validations paperclip introduces several validators to validate your attachment attachmentcontenttypevalidator attachmentpresencevalidator attachmentsizevalidator example usage ruby validates avatar attachment presence true validates with attachmentpresencevalidator attributes avatar validates with attachmentsizevalidator attributes avatar less than 1 megabytes validators can also be defined using the old helper style validates attachment presence validates attachment content type validates attachment size example usage ruby validates attachment presence avatar lastly you can also define multiple validations on a single attachment using validates attachment ruby validates attachment avatar presence true content type image jpeg size in 0 10 kilobytes note post processing will not even start if the attachment is not valid according to the validations your callbacks and processors will only be called with valid attachments ruby class message activerecord base has attached file asset styles thumb 100x100 before post process skip for audio def skip for audio w audio ogg application ogg include asset content type end end if you have other validations that depend on assignment order the recommended course of action is to prevent the assignment of the attachment until afterwards then assign manually ruby class book activerecord base has attached file document styles thumbnail 60x60 validates attachment document content type application pdf validates something else other validations that conflict with paperclips end class bookscontroller applicationcontroller def create book book new book params book document params book document book save respond with book end private def book params params require book permit title author end end a note on content type validations and security you should ensure that you validate files to be only those mime types you explicitly want to support if you dont you could be open to xss attacks if a user uploads a file with a malicious html payload if youre only interested in images restrict your allowed content types to image y ones ruby validates attachment avatar content type image jpeg image gif image png paperclip contenttypedetector will attempt to match a files extension to an inferred content type regardless of the actual contents of the file internationalization i18n for using or adding locale files in different languages check the project https github com thoughtbot paperclip i18n security validations thanks to a report from egor homakov we have taken steps to prevent people from spoofing content types and getting data you werent expecting onto your server note starting at version 4 0 0 all attachments are required to include a content type validation a file name validation or to explicitly state that theyre not going to have either paperclip will raise an error if you do not do this ruby class activerecord base has attached file avatar validate content type validates attachment content type avatar content type \aimage validate filename validates attachment file name avatar matches png\z jpe g\z explicitly do not validate do not validate attachment file type avatar end this keeps paperclip secure by default and will prevent people trying to mess with your filesystem note also starting at version 4 0 0 paperclip has another validation that cannot be turned off this validation will prevent content type spoofing that is uploading a php document for example as part of the exif tags of a well formed jpeg this check is limited to the media type the first part of the mime type so text in text plain this will prevent html documents from being uploaded as jpegs but will not prevent gifs from being uploaded with a jpg extension this validation will only add validation errors to the form it will not cause errors to be raised this can sometimes cause false validation errors in applications that use custom file extensions in these cases you may wish to add your custom extension to the list of content type mappings by creating config initializers paperclip rb ruby allow foo as an extension for files with the mime type text plain paperclip options content type mappings foo w text plain defaults global defaults for all your paperclip attachments can be defined by changing the paperclip attachment default options hash this can be useful for setting your default storage settings per example so you wont have to define them in every has attached file definition if youre using rails you can define a hash with default options in config application rb or in any of the config environments rb files on config paperclip defaults these will get merged into paperclip attachment default options as your rails app boots an example ruby module yourapp class application rails application other code config paperclip defaults storage fog fog credentials provider local local root rails root public fog directory fog host localhost end end another option is to directly modify the paperclip attachment default options hash this method works for non rails applications or is an option if you prefer to place the paperclip default settings in an initializer an example rails initializer would look something like this ruby paperclip attachment default options storage fog paperclip attachment default options fog credentials provider local local root rails root public paperclip attachment default options fog directory paperclip attachment default options fog host http localhost 3000 migrations paperclip defines several migration methods which can be used to create the necessary columns in your model there are two types of helper methods to aid in this as follows add attachment column to a table the attachment helper can be used when creating a table ruby class createuserswithattachments activerecord migration def up create table users do t t attachment avatar end end this is assuming you are only using the users table for paperclip attachment drop with care def down drop table users end end you can also use the change method instead of the up down combination above as shown below ruby class createuserswithattachments activerecord migration def change create table users do t t attachment avatar end end end schema definition alternatively the add attachment and remove attachment methods can be used to add new paperclip columns to an existing table ruby class addattachmentcolumnstousers activerecord migration def up add attachment users avatar end def down remove attachment users avatar end end or you can do this with the change method ruby class addattachmentcolumnstousers activerecord migration def change add attachment users avatar end end vintage syntax vintage syntax such as t has attached file and drop attached file is still supported in paperclip 3 x but youre advised to update those migration files to use this new syntax storage paperclip ships with 3 storage adapters file storage s3 storage via aws sdk s3 fog storage if you would like to use paperclip with another storage you can install these gems along side with paperclip paperclip azure paperclip azure storage paperclip dropbox understanding storage the files that are assigned as attachments are by default placed in the directory specified by the path option to has attached file by default this location is rails root public system class attachment id partition style filename this location was chosen because on standard capistrano deployments the public system directory can be symlinked to the apps shared directory meaning it survives between deployments for example using that path you may have a file at data myapp releases 20081229172410 public system users avatar 000 000 013 small my pic png note this is a change from previous versions of paperclip but is overall a safer choice for the default file store you may also choose to store your files using amazons s3 service to do so include the aws sdk s3 gem in your gemfile ruby gem aws sdk s3 and then you can specify using s3 from has attached file you can find more information about configuring and using s3 storage in the paperclip storage s3 documentation files on the local filesystem and in the rails apps public directory will be available to the internet at large if you require access control its possible to place your files in a different location you will need to change both the path and url options in order to make sure the files are unavailable to the public both path and url allow the same set of interpolated variables io adapters when a file is uploaded or attached it can be in one of a few different input forms from rails uploadedfile object to a stringio to a tempfile or even a simple string that is a url that points to an image paperclip will accept by default many of these sources it also is capable of handling even more with a little configuration the io adapters that handle images from non local sources are not enabled by default they can be enabled by adding a line similar to the following into config initializers paperclip rb ruby paperclip datauriadapter register its best to only enable a remote loading adapter if you need it otherwise theres a chance that someone can gain insight into your internal network structure using it as a vector the following adapters are not loaded by default paperclip uriadapter which accepts a uri instance paperclip httpurlproxyadapter which accepts a http string paperclip datauriadapter which accepts a base64 encoded data string post processing paperclip supports an extensible selection of post processors when you define a set of styles for an attachment by default it is expected that those styles are actually thumbnails these are processed by paperclip thumbnail for backward compatibility reasons you can pass either a single geometry string or an array containing a geometry and a format that the file will be converted to like so ruby has attached file avatar styles thumb 32x32 png this will convert the thumb style to a 32x32 square in png format regardless of what was uploaded if the format is not specified it is kept the same e g jpgs will remain jpgs paperclip thumbnail uses imagemagick to process images imagemagicks geometry documentation has more information on the accepted style formats for more fine grained control of the conversion process source file options and convert options can be used to pass flags and settings directly to imagemagicks powerful convert tool documented here for example ruby has attached file image styles regular 800x800 png source file options regular density 96 depth 8 quality 85 convert options regular posterize 3 imagemagick supports a number of environment variables for controlling its resource limits for example you can enforce memory or execution time limits by setting the following variables in your applications process environment magick memory limit 128mib magick map limit 64mib magick time limit 30 for a full list of variables and description see imagemagicks resources documentation custom attachment processors you can write your own custom attachment processors to carry out tasks like adding watermarks compressing images or encrypting files custom processors must be defined within the paperclip module inherit from paperclip processor see lib paperclip processor rb and implement a make method that returns a file all files in your rails apps lib paperclip and lib paperclip processors directories will be automatically loaded by paperclip processors are specified using the processors option to has attached file ruby has attached file scan styles text quality better processors ocr this would load the hypothetical class paperclip ocr and pass it the options hash quality better along with the uploaded file multiple processors can be specified and they will be invoked in the order they are defined in the processors array each successive processor is given the result from the previous processor all processors receive the same parameters which are defined in the styles hash for example assuming we had this definition ruby has attached file scan styles text quality better processors rotator ocr both the rotator processor and the ocr processor would receive the options quality better if a processor receives an option it doesnt recognise its expected to ignore it note because processors operate by turning the original attachment into the styles no processors will be run if there are no styles defined if youre interested in caching your thumbnails width height and size in the database take a look at the paperclip meta gem also if youre interested in generating the thumbnail on the fly you might want to look into the attachment on the fly gem paperclips thumbnail generator see lib paperclip thumbnail rb is implemented as a processor and may be a good reference for writing your own processors events before and after the post processing step paperclip calls back to the model with a few callbacks allowing the model to change or cancel the processing step the callbacks are before post process and after post process which are called before and after the processing of each attachment and the attachment specific before attachment post process and after attachment post process the callbacks are intended to be as close to normal activerecord callbacks as possible so if you return false specifically returning nil is not the same in a before filter the post processing step will halt returning false in an after filter will not halt anything but you can access the model and the attachment if necessary note post processing will not even start if the attachment is not valid according to the validations your callbacks and processors will only be called with valid attachments ruby class message activerecord base has attached file asset styles thumb 100x100 before post process skip for audio def skip for audio w audio ogg application ogg include asset content type end end uri obfuscation paperclip has an interpolation called hash for obfuscating filenames of publicly available files example usage ruby has attached file avatar url system hash extension hash secret longsecretstring the hash interpolation will be replaced with a unique hash made up of whatever is specified in hash data the default value for hash data is class attachment id style updated at hash secret is required an exception will be raised if hash is used without hash secret present for more on this feature read the authors own explanation checksum fingerprint a checksum of the original file assigned will be placed in the model if it has an attribute named fingerprint following the user model migration example above the migration would look like the following ruby class addavatarfingerprintcolumntouser activerecord migration def up add column users avatar fingerprint string end def down remove column users avatar fingerprint end end the algorithm can be specified using a configuration option it defaults to md5 for backwards compatibility with paperclip 5 and earlier ruby has attached file some attachment adapter options hash digest digest sha256 run class user attachment avatar rake paperclip refresh fingerprints after changing the digest on existing attachments to update the fingerprints in the database file preservation for soft delete an option is available to preserve attachments in order to play nicely with soft deleted models acts as paranoid paranoia etc ruby has attached file some attachment preserve files true this will prevent some attachment from being wiped out when the model gets destroyed so it will still exist when the object is restored later dynamic configuration callable objects lambdas procs can be used in a number of places for dynamic configuration throughout paperclip this strategy exists in a number of components of the library but is most significant in the possibilities for allowing custom styles and processors to be applied for specific model instances rather than applying defined styles and processors across all instances dynamic styles imagine a user model that had different styles based on the role of the user perhaps some users are bosses e g a user model instance responds to boss and merit a bigger avatar thumbnail than regular users the configuration to determine what style parameters are to be used based on the user role might look as follows where a boss will receive a 300x300 thumbnail otherwise a 100x100 thumbnail will be created ruby class user activerecord base has attached file avatar styles lambda attachment thumb attachment instance boss 300x300 100x100 end dynamic processors another contrived example is a user model that is aware of which file processors should be applied to it beyond the implied thumbnail processor invoked when styles are defined perhaps we have a watermark processor available and it is only used on the avatars of certain models the configuration for this might be where the instance is queried for which processors should be applied to it presumably some users might return thumbnail watermark for its processors where a defined watermark processor is invoked after the thumbnail processor already defined by paperclip ruby class user activerecord base has attached file avatar processors lambda instance instance processors attr accessor processors end logging by default paperclip outputs logging according to your logger level if you want to disable logging e g during testing add this into your environments configuration ruby your application configure do paperclip options log false end more information in the rdocs deployment to make capistrano symlink the public system directory so that attachments survive new deployments set the linked dirs option in your config deploy rb file ruby set linked dirs fetch linked dirs push public system attachment styles paperclip is aware of new attachment styles you have added in previous deploys the only thing you should do after each deployment is to call rake paperclip refresh missing styles it will store current attachment styles in rails root public system paperclip attachments yml by default you can change it by ruby paperclip registered attachments styles path tmp config paperclip attachments yml here is an example for capistrano ruby namespace paperclip do desc build missing paperclip styles task build missing styles do on roles app do within release path do with rails env fetch rails env do execute rake paperclip refresh missing styles end end end end end after deploy compile assets paperclip build missing styles now you dont have to remember to refresh thumbnails in production every time you add a new style unfortunately it does not work with dynamic styles it just ignores them if you already have a working app and dont want rake paperclip refresh missing styles to refresh old pictures you need to tell paperclip about existing styles simply create a paperclip attachments yml file by hand for example ruby class user activerecord base has attached file avatar styles thumb x100 croppable 600x600 big 1000x1000 end class book activerecord base has attached file cover styles small x100 large 1000x1000 has attached file sample styles thumb x100 end then in rails root public system paperclip attachments yml yml user avatar thumb croppable big book cover small large sample thumb testing paperclip provides rspec compatible matchers for testing attachments see the documentation on paperclip shoulda matchers for more information parallel tests because of the default path for paperclip storage if you try to run tests in parallel you may find that files get overwritten because the same path is being calculated for them in each test process while this fix works for parallel tests a similar concept should be used for any other mechanism for running tests concurrently ruby if env parallel test groups paperclip attachment default options path rails root public system rails env env test env number to i class attachment id partition filename else paperclip attachment default options path rails root public system rails env class attachment id partition filename end the important part here being the inclusion of env test env number or a similar mechanism for whichever parallel testing library you use integration tests using integration tests with factorybot may save multiple copies of your test files within the app to avoid this specify a custom path in the config environments test rb like so ruby paperclip attachment default options path rails root spec test files class id partition style extension then make sure to delete that directory after the test suite runs by adding this to spec helper rb ruby config after suite do fileutils rm rf dir rails root spec test files end example of test configuration with factory bot ruby factorybot define do factory user do avatar file new rails root spec support fixtures image jpg end end contributing if youd like to contribute a feature or bugfix thanks to make sure your fix feature has a high chance of being included please read the following guidelines post a pull request make sure there are tests we will not accept any patch that is not tested its a rare time when explicit tests arent needed if you have questions about writing tests for paperclip please open a github issue please see contributing md for more details on contributing and running test thank you to all the contributors license paperclip is copyright © 2008 2017 thoughtbot inc it is free software and may be redistributed under the terms specified in the mit license file about thoughtbot paperclip is maintained and funded by thoughtbot the names and logos for thoughtbot are trademarks of thoughtbot inc we love open source software see our other projects or hire us to design develop and grow your product